<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
    <title>Editar Medicamento</title>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav mx-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#">Servicios</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="javascript:window.location.href='usuarios.html'">Usuarios</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="javascript:window.location.href='mascotas.html'">Pacientes</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="javascript:window.location.href='medicamentos.html'">Medicamentos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Roles</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">✏️ Editar Medicamento</h3>
                        <button type="button" class="btn btn-light btn-sm" onclick="goBack()">
                            ← Volver
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Loading state -->
                        <div id="loadingState" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3 text-muted">Cargando datos del medicamento...</p>
                        </div>

                        <!-- Form -->
                        <form id="medicamentoForm" style="display: none;">
                            <div class="row">
                                <!-- ID (solo lectura) -->
                                <div class="col-md-12 mb-3">
                                    <label for="medicamentoId" class="form-label">ID del Medicamento</label>
                                    <input type="text" class="form-control" id="medicamentoId" readonly disabled>
                                </div>

                                <!-- Nombre del medicamento -->
                                <div class="col-md-12 mb-3">
                                    <label for="nombre" class="form-label">Nombre del Medicamento <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" required>
                                    <div class="invalid-feedback">
                                        Por favor ingrese el nombre del medicamento.
                                    </div>
                                </div>

                                <!-- Principio activo -->
                                <div class="col-md-6 mb-3">
                                    <label for="principioActivo" class="form-label">Principio Activo</label>
                                    <input type="text" class="form-control" id="principioActivo" name="principioActivo">
                                </div>

                                <!-- Laboratorio -->
                                <div class="col-md-6 mb-3">
                                    <label for="laboratorio" class="form-label">Laboratorio</label>
                                    <input type="text" class="form-control" id="laboratorio" name="laboratorio">
                                </div>

                                <!-- Dosis -->
                                <div class="col-md-6 mb-3">
                                    <label for="dosis" class="form-label">Dosis</label>
                                    <input type="text" class="form-control" id="dosis" name="dosis" placeholder="Ej: 500mg cada 8 horas">
                                </div>

                                <!-- Presentación -->
                                <div class="col-md-6 mb-3">
                                    <label for="presentacion" class="form-label">Presentación</label>
                                    <input type="text" class="form-control" id="presentacion" name="presentacion" placeholder="Ej: Cápsulas x 21 unidades">
                                </div>

                                <!-- Stock actual (solo lectura) -->
                                <div class="col-md-6 mb-3">
                                    <label for="stockActual" class="form-label">Stock Actual</label>
                                    <input type="text" class="form-control" id="stockActual" readonly disabled>
                                    <small class="form-text text-muted">
                                        Para ajustar el stock, use el botón de ajuste en la lista de medicamentos.
                                    </small>
                                </div>

                                <!-- Precio -->
                                <div class="col-md-6 mb-3">
                                    <label for="precio" class="form-label">Precio</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="precio" name="precio" min="0" step="0.01">
                                    </div>
                                    <div class="invalid-feedback">
                                        El precio no puede ser negativo.
                                    </div>
                                </div>

                                <!-- Requiere prescripción -->
                                <div class="col-md-12 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="requierePrescripcion" name="requierePrescripcion">
                                        <label class="form-check-label" for="requierePrescripcion">
                                            Requiere prescripción médica
                                        </label>
                                    </div>
                                </div>

                                <!-- Fechas de creación y actualización -->
                                <div class="col-md-6 mb-3">
                                    <label for="fechaCreacion" class="form-label">Fecha de Creación</label>
                                    <input type="text" class="form-control" id="fechaCreacion" readonly disabled>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="fechaActualizacion" class="form-label">Última Actualización</label>
                                    <input type="text" class="form-control" id="fechaActualizacion" readonly disabled>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-secondary me-md-2" onclick="goBack()">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-warning" id="submitBtn">
                                    <span class="spinner-border spinner-border-sm d-none" id="loadingSpinner" role="status" aria-hidden="true"></span>
                                    ✏️ Actualizar Medicamento
                                </button>
                            </div>
                        </form>

                        <!-- Error state -->
                        <div id="errorState" style="display: none;" class="text-center py-5">
                            <div class="text-danger mb-3">
                                <i class="fas fa-exclamation-triangle fa-3x"></i>
                            </div>
                            <h5 class="text-danger">Error al cargar el medicamento</h5>
                            <p class="text-muted">No se pudo cargar la información del medicamento.</p>
                            <button type="button" class="btn btn-primary" onclick="goBack()">
                                Volver a la lista
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de alerta -->
    <div class="alert alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" 
         role="alert" id="alertModal" style="display: none; z-index: 1050;">
        <span id="alertMessage"></span>
        <button type="button" class="btn-close" onclick="hideAlert()"></button>
    </div>

    <script>
        let medicamentoId = null;

        function goBack() {
            window.location.href = 'medicamentos.html';
        }

        function showAlert(message, type) {
            const alertModal = document.getElementById('alertModal');
            const alertMessage = document.getElementById('alertMessage');
            
            alertModal.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertMessage.textContent = message;
            alertModal.style.display = 'block';
            
            setTimeout(hideAlert, 5000);
        }

        function hideAlert() {
            const alertModal = document.getElementById('alertModal');
            alertModal.style.display = 'none';
        }

        function toggleLoading(isLoading) {
            const submitBtn = document.getElementById('submitBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            if (isLoading) {
                submitBtn.disabled = true;
                loadingSpinner.classList.remove('d-none');
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Actualizando...';
            } else {
                submitBtn.disabled = false;
                loadingSpinner.classList.add('d-none');
                submitBtn.innerHTML = '✏️ Actualizar Medicamento';
            }
        }

        function showState(state) {
            const loadingState = document.getElementById('loadingState');
            const form = document.getElementById('medicamentoForm');
            const errorState = document.getElementById('errorState');

            loadingState.style.display = state === 'loading' ? 'block' : 'none';
            form.style.display = state === 'form' ? 'block' : 'none';
            errorState.style.display = state === 'error' ? 'block' : 'none';
        }

        function getMedicamentoIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        function formatDate(dateString) {
            if (!dateString) return 'No disponible';
            const date = new Date(dateString);
            return date.toLocaleString('es-ES');
        }

        function fillForm(medicamento) {
            document.getElementById('medicamentoId').value = medicamento.id;
            document.getElementById('nombre').value = medicamento.nombre || '';
            document.getElementById('principioActivo').value = medicamento.principioActivo || '';
            document.getElementById('laboratorio').value = medicamento.laboratorio || '';
            document.getElementById('dosis').value = medicamento.dosis || '';
            document.getElementById('presentacion').value = medicamento.presentacion || '';
            document.getElementById('stockActual').value = `${medicamento.stock} unidades`;
            document.getElementById('precio').value = medicamento.precio || '';
            document.getElementById('requierePrescripcion').checked = medicamento.requierePrescripcion || false;
            document.getElementById('fechaCreacion').value = formatDate(medicamento.createdAt);
            document.getElementById('fechaActualizacion').value = formatDate(medicamento.updatedAt);
        }

        async function loadMedicamento() {
            const token = localStorage.getItem("token");
            
            if (!token) {
                showAlert("No hay sesión activa. Redirigiendo al login...", "warning");
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 2000);
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/medicamentos/${medicamentoId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const medicamento = await response.json();
                    fillForm(medicamento);
                    showState('form');
                } else if (response.status === 401) {
                    showAlert("Sesión expirada. Redirigiendo al login...", "warning");
                    localStorage.removeItem("token");
                    localStorage.removeItem("userId");
                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 2000);
                } else if (response.status === 404) {
                    showAlert("Medicamento no encontrado", "danger");
                    showState('error');
                } else {
                    const errorData = await response.json();
                    showAlert(`Error: ${errorData.message || 'Error al cargar medicamento'}`, 'danger');
                    showState('error');
                }
            } catch (error) {
                showAlert(`Error de conexión: ${error.message}`, 'danger');
                showState('error');
            }
        }

        function validateForm() {
            const nombre = document.getElementById('nombre').value.trim();
            const precio = document.getElementById('precio').value;

            // Validar nombre requerido
            if (!nombre) {
                document.getElementById('nombre').classList.add('is-invalid');
                showAlert('El nombre del medicamento es requerido', 'danger');
                return false;
            } else {
                document.getElementById('nombre').classList.remove('is-invalid');
            }

            // Validar precio no negativo
            if (precio && precio < 0) {
                document.getElementById('precio').classList.add('is-invalid');
                showAlert('El precio no puede ser negativo', 'danger');
                return false;
            } else {
                document.getElementById('precio').classList.remove('is-invalid');
            }

            return true;
        }

        async function updateMedicamento(formData) {
            const token = localStorage.getItem("token");
            
            try {
                const response = await fetch(`http://localhost:3000/api/medicamentos/${medicamentoId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const medicamento = await response.json();
                    showAlert('Medicamento actualizado correctamente', 'success');
                    
                    // Redirigir después de 2 segundos
                    setTimeout(() => {
                        window.location.href = 'medicamentos.html';
                    }, 2000);
                } else if (response.status === 401) {
                    showAlert("Sesión expirada. Redirigiendo al login...", "warning");
                    localStorage.removeItem("token");
                    localStorage.removeItem("userId");
                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showAlert(`Error: ${errorData.message || 'Error al actualizar medicamento'}`, 'danger');
                }
            } catch (error) {
                showAlert(`Error de conexión: ${error.message}`, 'danger');
            }
        }

        // Event listener para el formulario
        document.getElementById('medicamentoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            toggleLoading(true);

            const formData = {
                nombre: document.getElementById('nombre').value.trim(),
                principioActivo: document.getElementById('principioActivo').value.trim() || null,
                laboratorio: document.getElementById('laboratorio').value.trim() || null,
                dosis: document.getElementById('dosis').value.trim() || null,
                presentacion: document.getElementById('presentacion').value.trim() || null,
                precio: parseFloat(document.getElementById('precio').value) || null,
                requierePrescripcion: document.getElementById('requierePrescripcion').checked
            };

            await updateMedicamento(formData);
            toggleLoading(false);
        });

        // Validación en tiempo real
        document.getElementById('nombre').addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
            }
        });

        document.getElementById('precio').addEventListener('input', function() {
            if (!this.value || this.value >= 0) {
                this.classList.remove('is-invalid');
            }
        });

        // Inicialización al cargar la página
        window.onload = function() {
            const token = localStorage.getItem("token");
            const userId = localStorage.getItem("userId");
            
            if (!token || !userId) {
                showAlert("No hay sesión activa. Redirigiendo al login...", "warning");
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 2000);
                return;
            }

            // Obtener ID del medicamento de la URL
            medicamentoId = getMedicamentoIdFromUrl();
            
            if (!medicamentoId) {
                showAlert("ID de medicamento no válido", "danger");
                showState('error');
                return;
            }

            // Cargar datos del medicamento
            loadMedicamento();
        };
    </script>
</body>
</html>