<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
  <title>Pacientes - Veterinaria</title>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Veterinaria</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link" href="services.html">Servicios</a></li>
          <li class="nav-item"><a class="nav-link" href="usuarios.html">Usuarios</a></li>
          <li class="nav-item"><a class="nav-link active" href="mascotas.html">Pacientes</a></li>
          <li class="nav-item"><a class="nav-link" href="medicamentos.html">Medicamentos</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Roles</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Lista de pacientes -->
    <div class="card shadow">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">üêæ Lista de Pacientes</h3>
        <div>
          <button type="button" class="btn btn-primary" onclick="crearPaciente()">‚ûï Agregar Paciente</button>
        </div>
      </div>

      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0" id="pacientes-table">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Due√±o</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="pacientes-tbody">
              <tr>
                <td colspan="10" class="text-center py-4 text-muted">‚è≥ Cargando pacientes...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted" id="totalPacientes">Total: 0 pacientes</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Alertita -->
  <div class="alert alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3"
       role="alert" id="alertModal" style="display:none; z-index:1050;">
    <span id="alertMessage"></span>
    <button type="button" class="btn-close" onclick="hideAlert()"></button>
  </div>

  <script>
    let token = "";
    let pacientesCache = [];
    let totalPacientes = 0;

    function crearPaciente() { window.location.href = "addMascotas.html"; }
    function editarPaciente(id) { window.location.href = `editPaciente.html?id=${id}`; }

    function showAlert(message, type) {
      const alertModal = document.getElementById('alertModal');
      const alertMessage = document.getElementById('alertMessage');
      alertModal.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
      alertMessage.textContent = message;
      alertModal.style.display = 'block';
      setTimeout(hideAlert, 4000);
    }
    function hideAlert() { document.getElementById('alertModal').style.display = 'none'; }

    function safe(v, fallback = '‚Äî') {
      return (v === null || v === undefined || v === '') ? fallback : v;
    }

    function renderPacientes(items) {
      const tbody = document.getElementById('pacientes-tbody');
      const totalEl = document.getElementById('totalPacientes');

      if (!items || items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-muted">üîç No hay pacientes</td></tr>`;
        totalEl.textContent = `Total: 0 pacientes`;
        return;
      }

      tbody.innerHTML = items.map(m => {
        // Due√±o: intenta persona.nombre + apellido; si no, muestra #id
        let duenoTxt = '‚Äî';
        if (m.dueno) {
          const per = m.dueno.persona || {};
          const nombre = [per.nombre, per.apellido].filter(Boolean).join(' ').trim();
          duenoTxt = nombre ? `${nombre}` : `Propietario #${m.dueno.id}`;
        }

        return `
          <tr>
            <td>${m.id}</td>
            <td>${safe(m.nombre)}</td>
            <td>${duenoTxt}</td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary" title="Editar" onclick="editarPaciente(${m.id})">‚úèÔ∏è</button>
                <!-- Si quer√©s eliminar:
                <button class="btn btn-outline-danger" title="Eliminar" onclick="eliminarPaciente(${m.id})">üóëÔ∏è</button>
                -->
              </div>
            </td>
          </tr>`;
      }).join('');

      totalEl.textContent = `Total: ${totalPacientes} pacientes`;
    }

    async function loadPacientes() {
      const jwt = localStorage.getItem("token");
      const userId = localStorage.getItem("userId");

      if (!jwt || !userId) {
        showAlert("No hay sesi√≥n activa. Redirigiendo al login...", "warning");
        setTimeout(() => window.location.href = "login.html", 1500);
        return;
      }

      token = jwt;

      try {
        // Ideal: el backend incluye dueno->persona
        const res = await fetch(`http://localhost:3000/api/mascotas`, {
          headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" }
        });

        if (!res.ok) throw new Error(await res.text() || "Error al listar mascotas");

        const data = await res.json();
        // Soporta {items: [...], total} o lista directa
        pacientesCache = Array.isArray(data) ? data : (data.items || []);
        totalPacientes = Array.isArray(data) ? data.length : (data.total ?? pacientesCache.length);

        renderPacientes(pacientesCache);
      } catch (err) {
        showAlert(`Error al cargar pacientes: ${err.message}`, "danger");
        document.getElementById("pacientes-tbody").innerHTML =
          `<tr><td colspan="10" class="text-center py-4 text-danger">‚ùå ${String(err.message).replaceAll('<','&lt;')}</td></tr>`;
      }
    }

    window.onload = () => loadPacientes();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
