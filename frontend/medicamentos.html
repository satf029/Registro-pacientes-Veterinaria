<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  <title>Medicamentos Veterinaria</title>
</head>
<body class="bg-light">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold text-primary" href="services.html">üêæ Veterinaria</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link" href="services.html">Servicios</a></li>
          <li class="nav-item"><a class="nav-link" href="usuarios.html">Usuarios</a></li>
          <li class="nav-item"><a class="nav-link" href="mascotas.html">Pacientes</a></li>
          <li class="nav-item"><a class="nav-link active fw-bold" href="medicamentos.html">Medicamentos</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Roles</a></li>
          <li class="nav-item"><a class="nav-link" href="reporte.html">Reportes</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <div class="container mt-4">
    <div class="card shadow">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">üíä Lista de Medicamentos</h3>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-success" onclick="exportarInventario()">‚¨áÔ∏è Exportar Inventario</button>
          <button type="button" class="btn btn-primary" onclick="createProduct()">‚ûï Agregar Producto</button>
        </div>
      </div>

      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0" id="products-table">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Producto</th>
                <th>Categor√≠a</th>
                <th>Presentaci√≥n</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Prescripci√≥n</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="products-tbody">
              <tr>
                <td colspan="8" class="text-center py-4 text-muted">‚è≥ Cargando productos...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted" id="totalProductos">Total: 0 medicamentos</small>
          <div>
            <span class="badge bg-success me-2">‚óè Disponible</span>
            <span class="badge bg-warning me-2">‚óè Stock Bajo</span>
            <span class="badge bg-danger">‚óè Agotado</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerta flotante -->
  <div class="alert alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 shadow"
       role="alert" id="alertModal" style="display: none; z-index:2000;">
    <span id="alertMessage"></span>
    <button type="button" class="btn-close" onclick="hideAlert()"></button>
  </div>

  <script>
    let todosLosProductos = [];

    function createProduct(){ window.location.href = "addMedicamento.html"; }

    async function loadProducts() {
      const token = localStorage.getItem("token");
      const userId = localStorage.getItem("userId");

      if (!token || !userId) {
        showAlert("No hay sesi√≥n activa. Redirigiendo al login...", "warning");
        return setTimeout(()=> window.location.href="login.html",2000);
      }

      try {
        const res = await fetch("http://localhost:3000/api/medicamentos", {
          headers: { Authorization: `Bearer ${token}`, "Content-Type":"application/json" }
        });

        if(res.ok){
          const data = await res.json();
          todosLosProductos = data;
          renderProducts(data);
        } else if(res.status === 401){
          showAlert("Sesi√≥n expirada. Redirigiendo al login...", "warning");
          localStorage.clear();
          setTimeout(()=> window.location.href="login.html",2000);
        } else {
          const txt = await res.text();
          showAlert(`Error al cargar medicamentos: ${txt}`,"danger");
        }
      } catch(err){
        showAlert(`Error de conexi√≥n: ${err.message}`,"danger");
      }
    }

    function renderProducts(products){
      const tbody = document.getElementById("products-tbody");
      const totalEl = document.getElementById("totalProductos");

      if(!products || products.length===0){
        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted">üîç No hay medicamentos registrados</td></tr>`;
        totalEl.textContent = "Total: 0 medicamentos";
        return;
      }

      tbody.innerHTML = products.map(p=>{
        const categoria = getPrincipioActivoLabel(p.principioActivo);
        const estadoStock = getEstadoStock(p.stock,10);
        const precio = p.precio ? p.precio.toFixed(2) : "‚Äî";
        const prescripcion = p.requierePrescripcion
          ? '<span class="badge bg-warning">Requiere receta</span>'
          : '<span class="badge bg-info">Sin receta</span>';

        return `
          <tr>
            <td>${p.id}</td>
            <td><strong>${p.nombre}</strong>${p.dosis? `<br><small class="text-muted">Dosis: ${p.dosis}</small>`:''}</td>
            <td><span class="badge bg-secondary">${categoria}</span><br><small>${p.laboratorio || "‚Äî"}</small></td>
            <td>${p.presentacion || "‚Äî"}</td>
            <td>${precio}</td>
            <td><span class="badge ${estadoStock.class}">${p.stock} unid.</span><br>${estadoStock.badge}</td>
            <td>${prescripcion}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-warning" onclick="editProduct(${p.id})" title="Editar">‚úèÔ∏è</button>
                <button class="btn btn-success" onclick="adjustStock(${p.id})" title="Ajustar stock">üì¶</button>
                <button class="btn btn-danger" onclick="deleteProduct(${p.id},'${p.nombre}')" title="Eliminar">üóëÔ∏è</button>
              </div>
            </td>
          </tr>`;
      }).join("");

      totalEl.textContent = `Total: ${products.length} medicamentos`;
    }

    function getPrincipioActivoLabel(p){ return p ? (p.length>15? p.substring(0,15)+"...":p) : "‚Äî"; }
    function getEstadoStock(stock,min=10){
      if(stock===0) return {class:"bg-danger",badge:"<span class='badge bg-danger'>Agotado</span>"};
      if(stock<=min) return {class:"bg-warning",badge:"<span class='badge bg-warning'>Stock Bajo</span>"};
      return {class:"bg-success",badge:"<span class='badge bg-success'>Disponible</span>"};
    }

    async function editProduct(id){ window.location.href=`editMedicamento.html?id=${id}`; }

    async function adjustStock(id){
      const cantidad = prompt("Ingrese la cantidad (use - para salidas):");
      if(!cantidad) return;
      const n = parseInt(cantidad);
      if(isNaN(n)) return showAlert("Cantidad inv√°lida","danger");
      const tipo = n>0? "ENTRADA":"SALIDA";
      const motivo = prompt(`Motivo del ajuste de stock (${tipo}):`);
      if(motivo===null) return;

      const token = localStorage.getItem("token");
      try{
        const res = await fetch(`http://localhost:3000/api/medicamentos/${id}/stock`,{
          method:"PATCH",
          headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},
          body:JSON.stringify({tipo,cantidad:Math.abs(n),motivo})
        });
        if(res.ok){
          showAlert("Stock actualizado ‚úÖ","success");
          loadProducts();
        } else {
          const txt = await res.text();
          showAlert(`Error: ${txt}`,"danger");
        }
      }catch(err){ showAlert(`Error conexi√≥n: ${err.message}`,"danger"); }
    }

    async function deleteProduct(id,nombre){
      if(!confirm(`¬øEliminar el medicamento "${nombre}"?`)) return;
      const token = localStorage.getItem("token");
      try{
        const res = await fetch(`http://localhost:3000/api/medicamentos/${id}`,{
          method:"DELETE",
          headers:{Authorization:`Bearer ${token}`}
        });
        if(res.ok){
          showAlert(`"${nombre}" eliminado correctamente ‚úÖ`,"success");
          loadProducts();
        } else {
          const txt = await res.text();
          showAlert(`Error al eliminar: ${txt}`,"danger");
        }
      }catch(err){ showAlert(`Error conexi√≥n: ${err.message}`,"danger"); }
    }

    function exportarInventario(){
      let csv="ID,Nombre,Principio Activo,Laboratorio,Dosis,Presentacion,Stock,Precio,Prescripcion\n";
      todosLosProductos.forEach(p=>{
        csv+=`${p.id},"${p.nombre}","${p.principioActivo||""}","${p.laboratorio||""}","${p.dosis||""}","${p.presentacion||""}",${p.stock},${p.precio||0},${p.requierePrescripcion}\n`;
      });
      const blob=new Blob([csv],{type:"text/csv"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;a.download=`inventario_${new Date().toISOString().split("T")[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function showAlert(msg,type){
      const m=document.getElementById("alertModal"),t=document.getElementById("alertMessage");
      m.className=`alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 shadow`;
      t.textContent=msg;m.style.display="block";setTimeout(hideAlert,4000);
    }
    function hideAlert(){ document.getElementById("alertModal").style.display="none"; }

    window.onload=loadProducts;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
