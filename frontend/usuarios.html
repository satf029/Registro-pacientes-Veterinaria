<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
    <title>usuarios</title>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav mx-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">Servicios</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href = "javascript:window.location.href='usuarios.html'">Usuarios</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="javascript:window.location.href='mascotas.html'">Pacientes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="javascript:window.location.href='medicamentos.html'">Medicamentos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Roles</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="javascript:window.location.href='repote.html'">Reportes</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="container mt-4">
        <!-- Lista de usuarios -->
        <div class="card shadow">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">üë• Lista de Usuarios</h3>
                <button type="button" class="btn btn-primary" onclick="createUser()">
                    ‚ûï 
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="users-table">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Telefono</th>
                                <th>Documento</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr>
                                <td colspan="7" class="text-center py-4 text-muted">
                                    ‚è≥ Cargando usuarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        let token = "";
        
        async function createUser() {
            window.location.href ="addUser.html"
        }
        async function loadUsers() { 
            const token = localStorage.getItem("token"); 
            const userId = localStorage.getItem("userId"); 
            if (!token || !userId) {
                showAlert("No hay sesi√≥n activa. Redirigiendo al login...", "warning");
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 2000);
                return;
            } 
            try {
                const res = await fetch(`http://localhost:3000/api/users/${userId}`, { 
                    headers: { 
                        Authorization: `Bearer ${token}`,
                        "Content-Type": "application/json"
                    } 
                }); 
                
                if (res.ok) { 
                    const users = await res.json(); 
                    renderUsers(users);
                } else if (res.status === 401) {
                    showAlert("Sesi√≥n expirada. Redirigiendo al login...", "warning");
                    localStorage.removeItem("token");
                    localStorage.removeItem("userId");
                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 2000);
                } else { 
                    const errorText = await res.text();
                    showAlert(`Error al cargar usuarios: ${errorText}`, "danger");
                    document.getElementById("users-tbody").innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4 text-danger">
                                ‚ùå Error al cargar usuarios
                            </td>
                        </tr>
                    `;
                } 
            } catch (error) {
                showAlert(`Error de conexi√≥n: ${error.message}`, "danger");
                document.getElementById("users-tbody").innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-danger">
                            ‚ùå Error de conexi√≥n
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderUsers(users) {
            const tbody = document.getElementById("users-tbody");
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            üîç No hay otros usuarios registrados
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                // Extraer informaci√≥n de la persona asociada
                const persona = user.persona || {};
                const nombre = persona.nombre || 'Sin nombre';
                const apellido = persona.apellido || '';
                const nombreCompleto = `${nombre} ${apellido}`.trim();
                const email = persona.email || 'Sin email';
                const telefono = persona.telefono || 'Sin tel√©fono';
                const documento = persona.documento || 'Sin documento';
                const estado = user.activo ? 
                    '<span class="badge bg-success">Activo</span>' : 
                    '<span class="badge bg-danger">Inactivo</span>';
                
                return `
                    <tr>
                        <td>${user.id}</td>
                        <td>${nombreCompleto}</td>
                        <td>${email}</td>
                        <td>${telefono}</td>
                        <td>${documento}</td>
                        <td>${estado}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-warning btn-sm" onclick="editUser(${user.id})">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id}, '${nombreCompleto}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        // Cargar reservas al abrir la p√°gina 
        window.onload = loadUsers; 
    </script>
    
</body>
</html>